import pickle
from communication import *
import os

assert len(sys.argv) == 3
SETUP = False
secretf = sys.argv[2]

# try:
#     with open(secretf, "rb") as f:
#         SECRET_KEY = pickle.load(f)
#         PUBLIC_KEY = pickle.load(f)
#         print("Keys loaded successfully")
# except Exception as e:
#     print("Keys failed to load:", e)
#     raise
# print(get_hex_key(PUBLIC_KEY))

port = int(sys.argv[1])
secretf = sys.argv[2]

if SETUP == True:
    my_ip = "127.0.0.1"
    stats_address = ("127.0.0.1", 8999)
    my_http_address = "http://" + my_ip + ":" + str(port) + "/"
    my_address = (my_ip, port)
    # Se incarca cheia folosita pentru postat pe bulletin board
    try:
        with open(secretf, "rb") as f:
            SECRET_KEY = pickle.load(f)
            PUBLIC_KEY = pickle.load(f)
            print("Keys loaded successfully")
    except Exception as e:
        print("Keys failed to load:", e)
        raise

    # Se realizeaza inregistrarea serverului in mixnet primind p si lista de servere din mixnet
    response = register(stats_address, PUBLIC_KEY, my_http_address)
    # Se obtin informatii despre celelalte servere din mixnet
    peers_dic, peers_pk, peers_adr, peers_index, identity, network_ts = get_register_info(response, PUBLIC_KEY)
    # Se posteaza o dovada a cheii de criptare generate de server
    r, key_pair = send_network_pub_key(response, PUBLIC_KEY)
    # Se aduna toate dovezile serverelor din mixnet
    commits, network_ts = get_messages(peers_pk, network_ts)
    # Se deschid dovezile si se arata cheile de criptare
    open_commit(r, key_pair["publicKey"].h, PUBLIC_KEY)
    # Se verifica daca cheile de criptare corespund dovezilor
    result = verify_commits(commits, peers_pk, network_ts)
    identity += 1
    if result is not False:
        network_pub_keys, network_ts = result
    else:
        '''Someone sent wrong commit'''
        raise AttributeError("Wrong commit")

    network_pub_key = get_network_pub_key(key_pair["publicKey"].p, key_pair["publicKey"].g, network_pub_keys)
    # len(peers//2+1) in loc de 2
    f = gen_polynomial(len(peers_dic) // 2 + 1, (key_pair["privateKey"].p - 1) // 2, key_pair["privateKey"].x)

    commit_l = commit_poly_coefs(f, key_pair["privateKey"].g, key_pair["privateKey"].p)
    send_commit(commit_l, PUBLIC_KEY)
    messages, network_ts = get_messages(peers_pk, network_ts)
    # are commiturile adica g^(suma coeficientilor celorlalti) Fi
    Fi = {}
    for message in messages:
        Fi[message["W"]] = [int(coef) for coef in message["m"].split(" ")]

    share_senders = []
    for peer in peers_dic:
        if peer["public_key"] == get_hex_key(PUBLIC_KEY):
            continue
        share_senders.append(peer)

    server_thread = listen_shares(my_address, share_senders)

    # fiecarui membru i primeste rezultatul polinomului
    send_shares(f, peers_adr, peers_index, key_pair, PUBLIC_KEY)

    server_thread.join()

    req_list = []
    try:
        port_s = str(port)
        with open("requests" + port_s + ".txt", "rb") as reqs:
            while True:
                r = pickle.load(reqs)
                req_list.append(r)
    except EOFError:
        print("done")

    assert (check_shares(req_list, Fi, identity, key_pair["privateKey"].p, key_pair["privateKey"].g))

    shadow = 0
    for req in req_list:
        shadow += req["share"]

    shadow += calc_poly(f, identity, (key_pair["privateKey"].p - 1) // 2)
    shadow = shadow % ((key_pair["privateKey"].p - 1) // 2)

    network_priv_key = partial_interpol([i + 1 for i in range(len(peers_pk))], identity, shadow,
                                        (key_pair["privateKey"].p - 1) // 2)

    validate(stats_address, PUBLIC_KEY, my_http_address, network_pub_key)
    print("net_pub_key")
    print(network_pub_key)
    print("net_priv_key")
    print(network_priv_key)
    print("p")
    print(key_pair["privateKey"].p)
    print("g")
    print(key_pair["privateKey"].g)
    print("h")
    print(key_pair["publicKey"].h)
    print("peers_dic")
    print(peers_dic)
    os.environ["p"] = str(key_pair["privateKey"].p)
    os.environ["g"] = str(key_pair["privateKey"].g)
    os.environ["h"] = str(key_pair["publicKey"].h)
    os.environ["mixSecretKey"] = str(network_priv_key)
    os.environ["mixPublicKey"] = str(network_pub_key)
    os.environ["peers"] = json.dumps(peers_dic)
    os.environ["bboard_key"] = str(get_hex_key(PUBLIC_KEY))
    os.environ["identity"] = str(identity)
    os.environ["address"] = my_http_address
    quit(0)
else:
    os.environ[
        "p"] = "159894130690866518715676700679914580048989761067929251232658984640241370656048819478970540172400824940676291914583930673450312079276754347590810962921127772180565467551108089545135195352292977608077158096313520573423992659974844915883976947063226056290758241311189459697842977699382649575548521103800914436539"
    os.environ[
        "g"] = "10547051139819993035592588960585696514283723775938929413997989209319437855922291713060634847770885464456928156715275810980285468399273837176928041648262992562944600479250061123430862195569257263768267354281654377031027540419882670397742045164524593294540815253254444894526442136154969275137541190123317586897"
    os.environ[
        "mixPublicKey"] = "34122790996748996105192596466632391132341414603297034772427205567385798839405031923735856153299321018658754582231076021262233312887999264273597670273777795763889692215034039501428499143653792406008858440528037227914669773031294573552873281682058532200726465335172625615181207133075430957746266424891625926843"
    os.environ["peers"] = json.dumps([{
        'public_key': '800363656c67616d616c0a5075626c69634b65790a7100298171017d71022858010000007071038a81bb610cd55c4793866f4b8bc83a828a6077c750867954755af6fbb00f84545b63d84ab0bd901e9a12ca8ae64476c82309a0925ac34a08a70d2331f90ccda49a46ff102f9d10851805827aa9f52d56d4e48cfaaf8a84f2827f82f878e7049c0c57f937cac111a4d3e9ebb6e4fe30fdb1571c7d3ada4d154557772e26a47f61b2e30058010000006771048a81bdff57ccc95497f1c5ce70f1b51b6944887ba12894674d5cf49245ec8b63819f9005224f0286b1e4d973e7a9d7965052a6c466663d7141862ba8a6f1dfe3a4ffcb2d7b0d8b981808cfa3663bd94b22cbee4e8d643a158a487f7e33c2156bcda330303651b169226c9610e6a7ffc158e04cd3daa304f0e43f5bfdb79d7e49f8cd0058010000006871058a80f31e4fbf74fd4d9a3e8dd9fcd4ca742322daf6b2e63be91efb6c94563254314beecfe1db55e6285aeb7d1f8d306011b584e120db8a009c16477238d2e64fa548cceb672053fc5775a0b1163b8698185779e78736f3ad0df148fd453e5f73e7e1304977fb43ef85a74d809acaedbdbd38b2afdf4398c21d1041c1324b255f317a58070000006269745f6c656e71064d000475622e',
        'address': 'http://127.0.0.1:9001/'}, {
        'public_key': '800363656c67616d616c0a5075626c69634b65790a7100298171017d71022858010000007071038a81bb610cd55c4793866f4b8bc83a828a6077c750867954755af6fbb00f84545b63d84ab0bd901e9a12ca8ae64476c82309a0925ac34a08a70d2331f90ccda49a46ff102f9d10851805827aa9f52d56d4e48cfaaf8a84f2827f82f878e7049c0c57f937cac111a4d3e9ebb6e4fe30fdb1571c7d3ada4d154557772e26a47f61b2e30058010000006771048a81ea29caffd1ea27b7b5b0004295ce3b5497a501859a0dce3f5edea348ccfe3e1ec17fbdadd0ff30a605bc8f9c56ce410f8a3b418db37dc0df2f4aeccca46e6d6be1c00a650f7d52125eee579866fdd5ed43c5a71499295bf61418df8e0e452ec637026f4a36897de8e39c81eb751ae167c155642acece05312e5f45e7c1744d9c0058010000006871058a802e706923cddb23dd504972016c9f1f8829a3cc99be0d92d6c906f57757f4a1b372881a804ae24cd353cb79b6bd0ee97a4218c352f7c0a32b8b8243ccb2fc4aa7cb7d083bc39d653d43a82f8f2e94352eb2e3b57c11dc45251aa4aff39c43541cf9cce97495f8b0b672a0e92b257a64b333d0ee4833f9bcd6bed3f398b3e34e3c58070000006269745f6c656e71064d000475622e',
        'address': 'http://127.0.0.1:9002/'}, {
        'public_key': '800363656c67616d616c0a5075626c69634b65790a7100298171017d71022858010000007071038a81bb610cd55c4793866f4b8bc83a828a6077c750867954755af6fbb00f84545b63d84ab0bd901e9a12ca8ae64476c82309a0925ac34a08a70d2331f90ccda49a46ff102f9d10851805827aa9f52d56d4e48cfaaf8a84f2827f82f878e7049c0c57f937cac111a4d3e9ebb6e4fe30fdb1571c7d3ada4d154557772e26a47f61b2e30058010000006771048a808f7006b683945bf589244b82c8dacb3993788374d8153e0ad3df2c2850fbea7f35f29d5f9ccbce83ac36ba3626d785adb63805f6dfecbf06a164fdbd0765797e82315ca914ac4d4f1a0b76b11d962b6d8a84246dc168217d58b5916448520a210250934c3bbf295db7f458face5c184181ccccfe0f4249189003f655239bd92858010000006871058a80d9704b5443f446205cd5498215a326770d883c7a62d05cff75fed16cdd6e5b0201b14afc1de5b600f09e4b9a81f3041e4361f7cfacdc36c74278ab4ad486ab279c14dbcf26b8b1f27a49f94c1b198071a172a19510618b0f1759968a4cbed502c816647eeaeac1a91d38b26f244bfa8db4f2eab37ebc79f8e8335cad7422a43058070000006269745f6c656e71064d000475622e',
        'address': 'http://127.0.0.1:9003/'}])
    if sys.argv[1] == "9001":
        os.environ[
            "h"] = "37711700402328092516748855826506478772426356403835352448913240550399298818216606049215495737655893497949751546756975927753969706530044887359249491938498790165221957139389200412056787711996406884761051201928522713961542787854795165521698243031322322594044713665932167948848861504897731199228486636511434944248"
        os.environ[
            "mixSecretKey"] = "48123248525392298510840297795080217280190573784547064886278694086824725773153149479908062638288703059314920319559474080624612233578044003593559787038887305807607549596569182401024572248228020682793995672890587610320875682232203670381190149035126070072177375025782418163548291388744615251952316787344859759392"
        os.environ[
            "bboard_key"] = "800363656c67616d616c0a5075626c69634b65790a7100298171017d71022858010000007071038a81bb610cd55c4793866f4b8bc83a828a6077c750867954755af6fbb00f84545b63d84ab0bd901e9a12ca8ae64476c82309a0925ac34a08a70d2331f90ccda49a46ff102f9d10851805827aa9f52d56d4e48cfaaf8a84f2827f82f878e7049c0c57f937cac111a4d3e9ebb6e4fe30fdb1571c7d3ada4d154557772e26a47f61b2e30058010000006771048a81bdff57ccc95497f1c5ce70f1b51b6944887ba12894674d5cf49245ec8b63819f9005224f0286b1e4d973e7a9d7965052a6c466663d7141862ba8a6f1dfe3a4ffcb2d7b0d8b981808cfa3663bd94b22cbee4e8d643a158a487f7e33c2156bcda330303651b169226c9610e6a7ffc158e04cd3daa304f0e43f5bfdb79d7e49f8cd0058010000006871058a80f31e4fbf74fd4d9a3e8dd9fcd4ca742322daf6b2e63be91efb6c94563254314beecfe1db55e6285aeb7d1f8d306011b584e120db8a009c16477238d2e64fa548cceb672053fc5775a0b1163b8698185779e78736f3ad0df148fd453e5f73e7e1304977fb43ef85a74d809acaedbdbd38b2afdf4398c21d1041c1324b255f317a58070000006269745f6c656e71064d000475622e"
        os.environ["identity"] = "1"
        os.environ["address"] = 'http://127.0.0.1:9001/'
    elif sys.argv[1] == "9002":
        os.environ[
            "h"] = "94660842996107093460065414057906981470690983335838763328065477513467002290735542076908844857572202137001805667711411829455234014426442417337526923027487196078514838752193141068284964969173069272454121583027061805202169263167998033951962109841975863115080592948861940432031156050282794859375584821639695973248"
        os.environ[
            "mixSecretKey"] = "77350863230235409962313286243403914622684363322520866952187312467182979907103879085690692914404719410171257238126971591353756621241918758459606026407008599927259865223007913630605951399601403593194526273687461552356203568107021560181924851797418115415985138689243477589306968060417310742964110920856535335847"
        os.environ[
            "bboard_key"] = "800363656c67616d616c0a5075626c69634b65790a7100298171017d71022858010000007071038a81bb610cd55c4793866f4b8bc83a828a6077c750867954755af6fbb00f84545b63d84ab0bd901e9a12ca8ae64476c82309a0925ac34a08a70d2331f90ccda49a46ff102f9d10851805827aa9f52d56d4e48cfaaf8a84f2827f82f878e7049c0c57f937cac111a4d3e9ebb6e4fe30fdb1571c7d3ada4d154557772e26a47f61b2e30058010000006771048a81ea29caffd1ea27b7b5b0004295ce3b5497a501859a0dce3f5edea348ccfe3e1ec17fbdadd0ff30a605bc8f9c56ce410f8a3b418db37dc0df2f4aeccca46e6d6be1c00a650f7d52125eee579866fdd5ed43c5a71499295bf61418df8e0e452ec637026f4a36897de8e39c81eb751ae167c155642acece05312e5f45e7c1744d9c0058010000006871058a802e706923cddb23dd504972016c9f1f8829a3cc99be0d92d6c906f57757f4a1b372881a804ae24cd353cb79b6bd0ee97a4218c352f7c0a32b8b8243ccb2fc4aa7cb7d083bc39d653d43a82f8f2e94352eb2e3b57c11dc45251aa4aff39c43541cf9cce97495f8b0b672a0e92b257a64b333d0ee4833f9bcd6bed3f398b3e34e3c58070000006269745f6c656e71064d000475622e"
        os.environ["identity"] = "2"
        os.environ["address"] = 'http://127.0.0.1:9002/'
    elif sys.argv[1] == "9003":
        os.environ[
            "h"] = "119227752440397728724365407310715370817424008909879685549586258049140403482556114821986658024002020243838751160015955945739950305905453139293704465046110181370961060013927768276104413448515375379418072012846194230626285394987277430822145444966538352183715407719118205472133387997642142379761399963350915189766"
        os.environ[
            "mixSecretKey"] = "70581559665263299444799995430387630565702894454381121197183361954450860169940894442428314146624512689807982639658011843569733084286894143756970212832644218771739846835966132295539235027789373564843314861557097622085641314118693519859670676213243678493155182399533965105575723232129362644713745612197948694997"
        os.environ[
            "bboard_key"] = "800363656c67616d616c0a5075626c69634b65790a7100298171017d71022858010000007071038a81bb610cd55c4793866f4b8bc83a828a6077c750867954755af6fbb00f84545b63d84ab0bd901e9a12ca8ae64476c82309a0925ac34a08a70d2331f90ccda49a46ff102f9d10851805827aa9f52d56d4e48cfaaf8a84f2827f82f878e7049c0c57f937cac111a4d3e9ebb6e4fe30fdb1571c7d3ada4d154557772e26a47f61b2e30058010000006771048a808f7006b683945bf589244b82c8dacb3993788374d8153e0ad3df2c2850fbea7f35f29d5f9ccbce83ac36ba3626d785adb63805f6dfecbf06a164fdbd0765797e82315ca914ac4d4f1a0b76b11d962b6d8a84246dc168217d58b5916448520a210250934c3bbf295db7f458face5c184181ccccfe0f4249189003f655239bd92858010000006871058a80d9704b5443f446205cd5498215a326770d883c7a62d05cff75fed16cdd6e5b0201b14afc1de5b600f09e4b9a81f3041e4361f7cfacdc36c74278ab4ad486ab279c14dbcf26b8b1f27a49f94c1b198071a172a19510618b0f1759968a4cbed502c816647eeaeac1a91d38b26f244bfa8db4f2eab37ebc79f8e8335cad7422a43058070000006269745f6c656e71064d000475622e"
        os.environ["identity"] = "3"
        os.environ["address"] = 'http://127.0.0.1:9003/'

from routes import app

if __name__ == "__main__":
    app.run(port=port)
